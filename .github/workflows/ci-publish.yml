name: CI Build, Test and Publish

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-test-publish:
    runs-on: ubuntu-latest
    env:
      IMAGE_NAME: ${{ github.repository }}
      IMAGE_TAG: ${{ github.sha }}

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build image (no push)
      id: build
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        file: ./backend/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: false
        tags: ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }}

    - name: Run container for smoke tests
      run: |
        docker run -d --rm -p 4000:4000 --name service-web-test ${{ env.IMAGE_NAME }}:${{ env.IMAGE_TAG }} || (docker ps -a && docker logs service-web-test && exit 1)
        # wait for health
        for i in {1..30}; do
          if curl -fsS http://localhost:4000/api/health >/dev/null 2>&1; then echo 'healthy' && break; fi
          echo 'waiting...' && sleep 2
        done
        curl -fsS http://localhost:4000/api/health || (docker logs service-web-test && exit 1)
        curl -fsS http://localhost:4000/api/products || true
      timeout-minutes: 10

    - name: Stop test container
      if: always()
      run: |
        docker rm -f service-web-test || true

    - name: Push to Docker Hub
      if: secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN
      uses: docker/login-action@v2
      with:
        registry: docker.io
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Docker Hub push
      if: secrets.DOCKERHUB_USERNAME && secrets.DOCKERHUB_TOKEN
      uses: docker/build-push-action@v4
      with:
        context: ./backend
        file: ./backend/Dockerfile
        platforms: linux/amd64,linux/arm64
        push: true
        tags: |
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.repository }}:latest
          ${{ secrets.DOCKERHUB_USERNAME }}/${{ github.repository }}:${{ env.IMAGE_TAG }}

    - name: Configure AWS credentials
      if: secrets.AWS_ACCESS_KEY_ID && secrets.AWS_SECRET_ACCESS_KEY && secrets.AWS_REGION && secrets.AWS_ACCOUNT_ID
      uses: aws-actions/configure-aws-credentials@v2
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}

    - name: Push to AWS ECR
      if: secrets.AWS_ACCESS_KEY_ID && secrets.AWS_SECRET_ACCESS_KEY && secrets.AWS_REGION && secrets.AWS_ACCOUNT_ID
      run: |
        ECR_REG=${{ secrets.AWS_ACCOUNT_ID }}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com
        REPO_NAME=${{ github.repository }}
        docker build -f backend/Dockerfile -t $ECR_REG/$REPO_NAME:latest backend/
        aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin $ECR_REG
        aws ecr create-repository --repository-name $REPO_NAME --region ${{ secrets.AWS_REGION }} || true
        docker push $ECR_REG/$REPO_NAME:latest

    - name: Login to Azure and push to ACR
      if: secrets.AZURE_CLIENT_ID && secrets.AZURE_TENANT_ID && secrets.AZURE_CLIENT_SECRET && secrets.ACR_NAME
      uses: azure/login@v1
      with:
        creds: |
          {"clientId": "${{ secrets.AZURE_CLIENT_ID }}", "clientSecret": "${{ secrets.AZURE_CLIENT_SECRET }}", "tenantId": "${{ secrets.AZURE_TENANT_ID }}"}

    - name: Push to ACR
      if: secrets.AZURE_CLIENT_ID && secrets.AZURE_TENANT_ID && secrets.AZURE_CLIENT_SECRET && secrets.ACR_NAME
      run: |
        ACR=${{ secrets.ACR_NAME }}.azurecr.io
        REPO=${{ github.repository }}
        docker build -f backend/Dockerfile -t $ACR/$REPO:latest backend/
        echo "Logging into ACR $ACR"
        az acr login --name ${{ secrets.ACR_NAME }}
        docker push $ACR/$REPO:latest

    - name: Push to Google Container Registry (GCR)
      if: secrets.GCP_SA_KEY
      uses: google-github-actions/auth@v1
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}

    - name: GCR push
      if: secrets.GCP_SA_KEY
      run: |
        PROJECT=$(echo '${{ secrets.GCP_SA_KEY }}' | jq -r '.project_id')
        gcr=gcr.io/$PROJECT
        REPO=${{ github.repository }}
        docker build -f backend/Dockerfile -t $gcr/$REPO:latest backend/
        echo ${{ secrets.GCP_SA_KEY }} > /tmp/gcp-key.json
        gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
        gcloud auth configure-docker --quiet
        docker push $gcr/$REPO:latest

    - name: Create GitHub release (tag)
      if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ env.IMAGE_TAG }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Deploy to AWS ECS (force new deployment)
      if: secrets.AWS_ACCESS_KEY_ID && secrets.AWS_SECRET_ACCESS_KEY && secrets.AWS_REGION && secrets.ECS_CLUSTER && secrets.ECS_SERVICE
      run: |
        echo 'Triggering ECS service update (force new deployment)'
        aws ecs update-service --cluster ${{ secrets.ECS_CLUSTER }} --service ${{ secrets.ECS_SERVICE }} --force-new-deployment

    - name: Deploy to Azure Web App for Containers
      if: secrets.AZURE_CLIENT_ID && secrets.AZURE_TENANT_ID && secrets.AZURE_CLIENT_SECRET && secrets.AZURE_WEBAPP_NAME && secrets.AZURE_RESOURCE_GROUP && secrets.ACR_NAME
      run: |
        ACR=${{ secrets.ACR_NAME }}.azurecr.io
        IMAGE=$ACR/${{ github.repository }}:latest
        echo "Setting Web App (${{ secrets.AZURE_WEBAPP_NAME }}) to use image $IMAGE"
        az webapp config container set --name ${{ secrets.AZURE_WEBAPP_NAME }} --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} --docker-custom-image-name $IMAGE
        az webapp restart --name ${{ secrets.AZURE_WEBAPP_NAME }} --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }}

    - name: Deploy to Google Cloud Run
      if: secrets.GCP_SA_KEY && secrets.GCP_CLOUD_RUN_SERVICE && secrets.GCP_REGION
      run: |
        echo '${{ secrets.GCP_SA_KEY }}' > /tmp/gcp-key.json
        PROJECT=$(jq -r '.project_id' /tmp/gcp-key.json)
        IMAGE=gcr.io/$PROJECT/${{ github.repository }}:latest
        gcloud auth activate-service-account --key-file=/tmp/gcp-key.json
        gcloud config set project $PROJECT
        gcloud run deploy ${{ secrets.GCP_CLOUD_RUN_SERVICE }} --image $IMAGE --region ${{ secrets.GCP_REGION }} --platform managed --quiet

    - name: Deploy to Heroku (container)
      if: secrets.HEROKU_API_KEY && secrets.HEROKU_APP_NAME
      env:
        HEROKU_API_KEY: ${{ secrets.HEROKU_API_KEY }}
      run: |
        echo 'Deploying Docker image to Heroku container registry'
        echo $HEROKU_API_KEY | docker login --username=_ --password-stdin registry.heroku.com
        docker build -f backend/Dockerfile -t registry.heroku.com/${{ secrets.HEROKU_APP_NAME }}/web:latest backend/
        docker push registry.heroku.com/${{ secrets.HEROKU_APP_NAME }}/web:latest
        curl -n -X POST https://api.heroku.com/apps/${{ secrets.HEROKU_APP_NAME }}/releases \
          -H "Accept: application/vnd.heroku+json; version=3" \
          -H "Authorization: Bearer $HEROKU_API_KEY" \
          -H "Content-Type: application/json" \
          -d '{"slug":null}' || true

    - name: Deploy to DigitalOcean App Platform (trigger deployment)
      if: secrets.DO_API_TOKEN && secrets.DO_APP_ID
      env:
        DIGITALOCEAN_ACCESS_TOKEN: ${{ secrets.DO_API_TOKEN }}
      run: |
        curl -sL https://github.com/digitalocean/doctl/releases/latest/download/doctl-$(uname -s)-amd64.tar.gz | tar -xz
        sudo mv doctl /usr/local/bin/doctl || true
        doctl auth init -t $DIGITALOCEAN_ACCESS_TOKEN
        echo 'Triggering DigitalOcean App deployment for app id' ${{ secrets.DO_APP_ID }}
        doctl apps create-deployment ${{ secrets.DO_APP_ID }} || doctl apps update ${{ secrets.DO_APP_ID }} || true
