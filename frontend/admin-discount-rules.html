<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Discount Rules Manager - Admin</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Segoe UI', sans-serif; background: #f5f5f5; color: #333; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    header { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px; }
    header h1 { font-size: 28px; margin-bottom: 5px; }
    .auth-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .auth-section input { padding: 10px; border: 1px solid #ddd; border-radius: 4px; margin-right: 10px; flex: 1; }
    .auth-section > div { display: flex; gap: 10px; }
    .form-section { background: white; padding: 20px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .form-section h2 { color: #f5576c; margin-bottom: 15px; font-size: 18px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 5px; font-weight: 600; }
    .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; font-family: inherit; }
    .form-group input[type="datetime-local"] { font-family: inherit; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    button { padding: 10px 20px; background: #f5576c; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; }
    button:hover { background: #e63946; }
    button.secondary { background: #999; }
    button.secondary:hover { background: #777; }
    .rules-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
    .rule-card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); border-left: 4px solid #f5576c; }
    .rule-card h3 { color: #333; margin-bottom: 10px; }
    .rule-card p { margin: 8px 0; font-size: 14px; color: #666; }
    .rule-card .badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 600; margin: 5px 5px 5px 0; }
    .badge-active { background: #e8f5e9; color: #388e3c; }
    .badge-inactive { background: #ffebee; color: #c62828; }
    .badge-category { background: #e3f2fd; color: #1976d2; }
    .rule-actions { margin-top: 15px; display: flex; gap: 10px; }
    .rule-actions button { padding: 6px 12px; font-size: 12px; flex: 1; }
    .loading { text-align: center; padding: 40px; color: #999; }
    .error { background: #ffebee; color: #c62828; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
    .success { background: #e8f5e9; color: #2e7d32; padding: 15px; border-radius: 4px; margin-bottom: 20px; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 30px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-content h2 { margin-bottom: 20px; color: #333; }
    .close-modal { float: right; cursor: pointer; font-size: 24px; color: #999; }
    .close-modal:hover { color: #333; }
    .no-rules { text-align: center; padding: 40px; color: #999; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ðŸŽ¯ Discount Rules Manager</h1>
      <p>Create and manage category-specific discount rules</p>
    </header>

    <div class="auth-section">
      <div>
        <input type="text" id="tokenInput" placeholder="Paste admin JWT token here...">
        <button onclick="loadRules()">Load Rules</button>
        <button class="secondary" onclick="document.getElementById('tokenInput').value = ''">Clear</button>
      </div>
    </div>

    <div id="message"></div>

    <!-- Create Rule Form -->
    <div class="form-section" style="display: none;" id="formSection">
      <h2>Create New Discount Rule</h2>
      <form onsubmit="createRule(event)">
        <div class="form-group">
          <label>Rule Name</label>
          <input type="text" id="ruleName" placeholder="e.g., Winter Fashion Sale" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Category</label>
            <select id="categorySelect" required></select>
          </div>
          <div class="form-group">
            <label>Discount (%)</label>
            <input type="number" id="discountPercent" placeholder="e.g., 10" min="0" max="100" required>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Max Discount ($)</label>
            <input type="number" id="maxDiscount" placeholder="e.g., 50" min="0" step="0.01">
          </div>
          <div class="form-group">
            <label>Active</label>
            <select id="active">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Start Date</label>
            <input type="datetime-local" id="startAt">
          </div>
          <div class="form-group">
            <label>End Date</label>
            <input type="datetime-local" id="endAt">
          </div>
        </div>
        <button type="submit" style="width: 100%;">Create Discount Rule</button>
      </form>
    </div>

    <!-- Rules List -->
    <div id="rulesSection" style="display: none;">
      <h2 style="margin-bottom: 20px; font-size: 20px;">Active Discount Rules</h2>
      <div class="rules-grid" id="rulesGrid"></div>
    </div>

    <div id="noRules" class="no-rules" style="display: none;">
      <p>No discount rules created yet</p>
    </div>
  </div>

  <!-- Edit Rule Modal -->
  <div class="modal" id="editModal">
    <div class="modal-content">
      <span class="close-modal" onclick="closeEditModal()">&times;</span>
      <h2>Edit Discount Rule</h2>
      <form onsubmit="updateRule(event)">
        <input type="hidden" id="editRuleId">
        <div class="form-group">
          <label>Rule Name</label>
          <input type="text" id="editRuleName" required>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Discount (%)</label>
            <input type="number" id="editDiscountPercent" min="0" max="100" required>
          </div>
          <div class="form-group">
            <label>Max Discount ($)</label>
            <input type="number" id="editMaxDiscount" min="0" step="0.01">
          </div>
        </div>
        <div class="form-group">
          <label>Active</label>
          <select id="editActive">
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label>Start Date</label>
            <input type="datetime-local" id="editStartAt">
          </div>
          <div class="form-group">
            <label>End Date</label>
            <input type="datetime-local" id="editEndAt">
          </div>
        </div>
        <button type="submit" style="width: 100%; margin-top: 15px;">Save Changes</button>
      </form>
    </div>
  </div>

  <script>
    let currentToken = null;
    let categories = [];

    async function loadRules() {
      const token = document.getElementById('tokenInput').value.trim();
      if (!token) {
        showMessage('Please paste your admin token', 'error');
        return;
      }
      currentToken = token;
      showMessage('Loading discount rules...', 'loading');

      try {
        // Load categories first
        const catResp = await fetch('http://localhost:4000/api/categories');
        if (catResp.ok) {
          categories = await catResp.json();
          populateCategorySelect();
        }

        // Load rules
        const resp = await fetch('http://localhost:4000/api/admin/discount-rules', {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          }
        });

        if (!resp.ok) {
          const error = await resp.json();
          throw new Error(error.error || `HTTP ${resp.status}`);
        }

        const rules = await resp.json();
        renderRules(rules);
        showMessage('Discount rules loaded!', 'success');
        document.getElementById('formSection').style.display = 'block';
        document.getElementById('rulesSection').style.display = 'block';
      } catch (err) {
        showMessage('Error: ' + err.message, 'error');
        document.getElementById('formSection').style.display = 'none';
      }
    }

    function populateCategorySelect() {
      const select = document.getElementById('categorySelect');
      select.innerHTML = '<option value="">Select category...</option>';
      categories.forEach(cat => {
        const opt = document.createElement('option');
        opt.value = cat.id;
        opt.textContent = `${cat.name} (${cat.commissionRate * 100}% commission)`;
        select.appendChild(opt);
      });
    }

    function renderRules(rules) {
      const grid = document.getElementById('rulesGrid');
      const section = document.getElementById('rulesSection');
      const noRules = document.getElementById('noRules');

      if (rules.length === 0) {
        grid.innerHTML = '';
        section.style.display = 'none';
        noRules.style.display = 'block';
        return;
      }

      noRules.style.display = 'none';
      section.style.display = 'block';
      grid.innerHTML = rules.map(rule => {
        const cat = categories.find(c => c.id === rule.categoryId);
        const catName = cat ? cat.name : rule.categoryId;
        const status = rule.active ? 'Active' : 'Inactive';
        const statusBadge = rule.active ? 'badge-active' : 'badge-inactive';
        const startDate = new Date(rule.startAt).toLocaleDateString();
        const endDate = rule.endAt ? new Date(rule.endAt).toLocaleDateString() : 'No end date';

        return `
          <div class="rule-card">
            <h3>${rule.name}</h3>
            <span class="badge ${statusBadge}">${status}</span>
            <span class="badge badge-category">${catName}</span>
            <p><strong>Discount:</strong> ${rule.discountPercent}%</p>
            <p><strong>Max Discount:</strong> ${rule.maxDiscount ? '$' + rule.maxDiscount : 'Unlimited'}</p>
            <p><strong>Valid:</strong> ${startDate} to ${endDate}</p>
            <div class="rule-actions">
              <button onclick="editRule('${rule.id}', ${JSON.stringify(rule).replace(/'/g, '&#39;')})">Edit</button>
              <button class="secondary" onclick="deleteRule('${rule.id}')">Delete</button>
            </div>
          </div>
        `;
      }).join('');
    }

    async function createRule(event) {
      event.preventDefault();
      const rule = {
        name: document.getElementById('ruleName').value,
        categoryId: document.getElementById('categorySelect').value,
        discountPercent: parseFloat(document.getElementById('discountPercent').value),
        maxDiscount: document.getElementById('maxDiscount').value ? parseFloat(document.getElementById('maxDiscount').value) : null,
        active: document.getElementById('active').value === 'true',
        startAt: document.getElementById('startAt').value ? new Date(document.getElementById('startAt').value).toISOString() : new Date().toISOString(),
        endAt: document.getElementById('endAt').value ? new Date(document.getElementById('endAt').value).toISOString() : null
      };

      try {
        const resp = await fetch('http://localhost:4000/api/admin/discount-rules', {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(rule)
        });

        if (!resp.ok) {
          const error = await resp.json();
          throw new Error(error.error || 'Failed to create rule');
        }

        showMessage('Discount rule created!', 'success');
        event.target.reset();
        loadRules();
      } catch (err) {
        showMessage('Error: ' + err.message, 'error');
      }
    }

    function editRule(ruleId, rule) {
      document.getElementById('editRuleId').value = ruleId;
      document.getElementById('editRuleName').value = rule.name;
      document.getElementById('editDiscountPercent').value = rule.discountPercent;
      document.getElementById('editMaxDiscount').value = rule.maxDiscount || '';
      document.getElementById('editActive').value = rule.active;
      if (rule.startAt) {
        const startDate = new Date(rule.startAt);
        document.getElementById('editStartAt').value = startDate.toISOString().slice(0, 16);
      }
      if (rule.endAt) {
        const endDate = new Date(rule.endAt);
        document.getElementById('editEndAt').value = endDate.toISOString().slice(0, 16);
      }
      document.getElementById('editModal').classList.add('active');
    }

    function closeEditModal() {
      document.getElementById('editModal').classList.remove('active');
    }

    async function updateRule(event) {
      event.preventDefault();
      const ruleId = document.getElementById('editRuleId').value;
      const rule = {
        name: document.getElementById('editRuleName').value,
        discountPercent: parseFloat(document.getElementById('editDiscountPercent').value),
        maxDiscount: document.getElementById('editMaxDiscount').value ? parseFloat(document.getElementById('editMaxDiscount').value) : null,
        active: document.getElementById('editActive').value === 'true',
        startAt: document.getElementById('editStartAt').value ? new Date(document.getElementById('editStartAt').value).toISOString() : null,
        endAt: document.getElementById('editEndAt').value ? new Date(document.getElementById('editEndAt').value).toISOString() : null
      };

      try {
        const resp = await fetch(`http://localhost:4000/api/admin/discount-rules/${ruleId}`, {
          method: 'PUT',
          headers: {
            'Authorization': `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(rule)
        });

        if (!resp.ok) {
          const error = await resp.json();
          throw new Error(error.error || 'Failed to update rule');
        }

        showMessage('Discount rule updated!', 'success');
        closeEditModal();
        loadRules();
      } catch (err) {
        showMessage('Error: ' + err.message, 'error');
      }
    }

    async function deleteRule(ruleId) {
      if (!confirm('Delete this discount rule?')) return;

      try {
        const resp = await fetch(`http://localhost:4000/api/admin/discount-rules/${ruleId}`, {
          method: 'DELETE',
          headers: {
            'Authorization': `Bearer ${currentToken}`,
            'Content-Type': 'application/json'
          }
        });

        if (!resp.ok) {
          const error = await resp.json();
          throw new Error(error.error || 'Failed to delete rule');
        }

        showMessage('Discount rule deleted!', 'success');
        loadRules();
      } catch (err) {
        showMessage('Error: ' + err.message, 'error');
      }
    }

    function showMessage(msg, type) {
      const div = document.getElementById('message');
      div.textContent = msg;
      div.className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'loading';
      if (type !== 'loading') setTimeout(() => div.textContent = '', 3000);
    }

    document.getElementById('tokenInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') loadRules();
    });
  </script>
</body>
</html>
